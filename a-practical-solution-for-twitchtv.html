<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>A practical solution for Twitch.tv</title>
    <link rel="icon" href="https://sulami.github.io/favicon.ico" />
    <link rel="stylesheet" href="https://sulami.github.io/theme/css/main.css" />
    <link href="https://sulami.github.io/feed/rss.xml" type="application/rss+xml" rel="alternate" title="/dev/sulami >> blog RSS Feed" />

    <!--[if IE]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

<body id="index" class="home">
    <header id="banner" class="body">
            <nav>
            <a href="https://sulami.github.io/">/dev/sulami >> blog</a> |
                <a href="https://sulami.github.io/pages/about-me.html">About me</a>
                <a href="https://sulami.github.io/category/coding.html">Coding</a>
                <a href="https://sulami.github.io/category/hardware.html">Hardware</a>
                <a href="https://sulami.github.io/category/linux.html">Linux</a>
                <a href="https://sulami.github.io/category/web.html">Web</a>
            <a href="https://sulami.github.io/feed/rss.xml">RSS</a>
            </nav>
    </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        >>
        <a href="https://sulami.github.io/a-practical-solution-for-twitchtv.html" rel="bookmark"
           title="Permalink to A practical solution for Twitch.tv">A practical solution for Twitch.tv</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
    <span class="date">2015-02-08</span>
    |
    in <a href="https://sulami.github.io/category/web.html">Web</a>
    | tags: <a href="https://sulami.github.io/tag/twitchtv.html">twitchtv</a> <a href="https://sulami.github.io/tag/alsa.html">alsa</a> <a href="https://sulami.github.io/tag/ffmpeg.html">ffmpeg</a> <a href="https://sulami.github.io/tag/pulse.html">pulse</a> </footer><!-- /.post-info -->
      <p>I have now written three scripts to stream to Twitch.tv from Linux, and all of
them were just hardcoded ffmpeg commands. Today I am proud to present an actual
streaming script that takes arguments and passes them to ffmpeg in the proper
way to enable streaming.</p>
<div class="codehilite"><pre><span class="nv">SIZE</span><span class="o">=</span><span class="s2">&quot;1920x1080&quot;</span>
<span class="nv">RESOLUTION</span><span class="o">=</span><span class="s2">&quot;1280x720&quot;</span>
<span class="nv">FRAMERATE</span><span class="o">=</span><span class="s2">&quot;30&quot;</span>
<span class="nv">STREAMKEY</span><span class="o">=</span><span class="s2">&quot;live_123_abc&quot;</span>
<span class="nv">THREADS</span><span class="o">=</span><span class="s2">&quot;8&quot;</span>
<span class="nv">BITRATE</span><span class="o">=</span><span class="s2">&quot;2048&quot;</span>
<span class="nv">AUDIO</span><span class="o">=</span><span class="s2">&quot;pulse&quot;</span>
<span class="nv">CHANNELS</span><span class="o">=</span><span class="s2">&quot;2&quot;</span>
<span class="nv">VERBOSE</span><span class="o">=</span><span class="nb">false</span>

<span class="k">while</span> <span class="nb">getopts</span> <span class="s2">&quot;:s:r:f:k:t:b:a:c:vh&quot;</span> opt<span class="p">;</span> <span class="k">do</span>
    <span class="k">case</span> <span class="nv">$opt</span> in
        s<span class="o">)</span>
            <span class="nv">SIZE</span><span class="o">=</span><span class="nv">$OPTARG</span>
            <span class="p">;;</span>
        r<span class="o">)</span>
            <span class="nv">RESOLUTION</span><span class="o">=</span><span class="nv">$OPTARG</span>
            <span class="p">;;</span>
        f<span class="o">)</span>
            <span class="nv">FRAMERATE</span><span class="o">=</span><span class="nv">$OPTARG</span>
            <span class="p">;;</span>
        k<span class="o">)</span>
            <span class="nv">STREAMKEY</span><span class="o">=</span><span class="nv">$OPTARG</span>
            <span class="p">;;</span>
        t<span class="o">)</span>
            <span class="nv">THREADS</span><span class="o">=</span><span class="nv">$OPTARG</span>
            <span class="p">;;</span>
        b<span class="o">)</span>
            <span class="nv">BITRATE</span><span class="o">=</span><span class="nv">$OPTARG</span>
            <span class="p">;;</span>
        a<span class="o">)</span>
            <span class="nv">AUDIO</span><span class="o">=</span><span class="nv">$OPTARG</span>
            <span class="p">;;</span>
        c<span class="o">)</span>
            <span class="nv">CHANNELS</span><span class="o">=</span><span class="nv">$OPTARG</span>
            <span class="p">;;</span>
        v<span class="o">)</span>
            <span class="nv">VERBOSE</span><span class="o">=</span><span class="nb">true</span>
            <span class="p">;;</span>
        h<span class="o">)</span>
            <span class="nb">echo</span> <span class="s2">&quot;Options:&quot;</span>
            <span class="nb">echo</span> <span class="s2">&quot;  -s &lt;int&gt;x&lt;int&gt;  - Desktop size (def: 1920x1080)&quot;</span>
            <span class="nb">echo</span> <span class="s2">&quot;  -r &lt;int&gt;x&lt;int&gt;  - Stream resolution (def: 1280x720)&quot;</span>
            <span class="nb">echo</span> <span class="s2">&quot;  -f &lt;int&gt;        - Framerate (def: 30)&quot;</span>
            <span class="nb">echo</span> <span class="s2">&quot;  -k &lt;str&gt;        - Streamkey (Acquire from Twitch.tv)&quot;</span>
            <span class="nb">echo</span> <span class="s2">&quot;  -t &lt;int&gt;        - Threads (def: 8)&quot;</span>
            <span class="nb">echo</span> <span class="s2">&quot;  -b &lt;int&gt;        - Video bitrate in kb/s (def: 2048)&quot;</span>
            <span class="nb">echo</span> <span class="s2">&quot;  -a &lt;str&gt;        - Audio framework (def: pulse)&quot;</span>
            <span class="nb">echo</span> <span class="s2">&quot;  -c &lt;int&gt;        - Audio Channels (def: 2)&quot;</span>
            <span class="nb">echo</span> <span class="s2">&quot;  -v              - Verbose output&quot;</span>
            <span class="nb">echo</span> <span class="s2">&quot;  -h              - This help output&quot;</span>
            <span class="nb">exit </span>0
            <span class="p">;;</span>
        <span class="se">\?</span><span class="o">)</span>
            <span class="nb">echo</span> <span class="s2">&quot;Invalid option: -</span><span class="nv">$OPTARG</span><span class="s2">&quot;</span> &gt;<span class="p">&amp;</span>2
            <span class="nb">exit </span>1
            <span class="p">;;</span>
        :<span class="o">)</span>
            <span class="nb">echo</span> <span class="s2">&quot;Option -</span><span class="nv">$OPTARG</span><span class="s2"> requires and argument&quot;</span> &gt;<span class="p">&amp;</span>2
            <span class="nb">exit </span>1
            <span class="p">;;</span>
    <span class="k">esac</span>
<span class="k">done</span>

<span class="k">for</span> c in <span class="sb">`</span>seq <span class="si">${</span><span class="nv">CHANNELS</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span> <span class="k">do</span>
    <span class="nv">AUDIOCODE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$AUDIOCODE</span><span class="s2"> -f </span><span class="nv">$AUDIO</span><span class="s2"> -i default&quot;</span>
<span class="k">done</span>

ffmpeg <span class="se">\</span>
-f x11grab <span class="se">\</span>
-video_size <span class="si">${</span><span class="nv">SIZE</span><span class="si">}</span> <span class="se">\</span>
-framerate <span class="si">${</span><span class="nv">FRAMERATE</span><span class="si">}</span> <span class="se">\</span>
-i :0.0+0,0 <span class="se">\</span>
<span class="nv">$AUDIOCODE</span> <span class="se">\</span>
-vcodec libx264 <span class="se">\</span>
-preset medium <span class="se">\</span>
-s <span class="si">${</span><span class="nv">RESOLUTION</span><span class="si">}</span> <span class="se">\</span>
-b:v <span class="si">${</span><span class="nv">BITRATE</span><span class="si">}</span>k <span class="se">\</span>
-minrate <span class="si">${</span><span class="nv">BITRATE</span><span class="si">}</span>k <span class="se">\</span>
-maxrate <span class="si">${</span><span class="nv">BITRATE</span><span class="si">}</span>k <span class="se">\</span>
-bufsize <span class="k">$((</span><span class="m">2</span> <span class="o">*</span> <span class="si">${</span><span class="nv">BITRATE</span><span class="si">}</span><span class="k">))</span>k <span class="se">\</span>
-g <span class="k">$((</span><span class="m">2</span> <span class="o">*</span> <span class="si">${</span><span class="nv">FRAMERATE</span><span class="si">}</span><span class="k">))</span> <span class="se">\</span>
-filter_complex <span class="nv">amix</span><span class="o">=</span><span class="nv">inputs</span><span class="o">=</span><span class="si">${</span><span class="nv">CHANNELS</span><span class="si">}</span>:duration<span class="o">=</span>first:dropout_transition<span class="o">=</span><span class="m">3</span> <span class="se">\</span>
-acodec libmp3lame <span class="se">\</span>
-ar <span class="m">44100</span> <span class="se">\</span>
-b:a 128k <span class="se">\</span>
-threads <span class="si">${</span><span class="nv">THREADS</span><span class="si">}</span> <span class="se">\</span>
-pix_fmt yuv420p <span class="se">\</span>
-f flv rtmp://live.justin.tv/app/<span class="si">${</span><span class="nv">STREAMKEY</span><span class="si">}</span>
</pre></div>


<p>I will update this post as I update the script, and maybe setup a separate Git
repo some day.</p>
    </div><!-- /.entry-content -->
  </article>
</section>
</body>
</html>
